<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alfaham TV</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
  
  * {
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    padding: 0;
    font-family: 'Cairo', sans-serif;
    background: url('https://i.top4top.io/p_3586ia2q10.png') no-repeat center center fixed;
    background-size: cover;
    color: #fff;
    background-color: #0a0a0a;
    min-height: 100vh;
  }
  
  .container, .channels-container {
    padding: 10px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px;
    direction: rtl;
  }
  
  .section-card, .channel-card {
    background: #ffffff;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    border: 1px solid #e8e8e8;
    overflow: hidden;
    height: 200px;
  }

  .section-card:hover, .channel-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }

  .section-image, .channel-logo {
    width: 140px;
    height: 140px;
    object-fit: cover;
    border-radius: 10px;
    margin-top: 8px;
    border: 1px solid #f0f0f0;
    background: #ffffff;
  }

  .section-title, .channel-name {
    font-weight: 700;
    font-size: 0.95rem;
    color: #000000;
    width: 100%;
    text-align: center;
    padding: 8px 5px;
    margin: 0;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    border-top: 1px solid #f0f0f0;
    background: #f8f8f8;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* المشغل - نفس التصميم الأصلي */
  #playerContainer {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: black;
    z-index: 10000;
    overflow: hidden;
    flex-direction: column;
  }

  #videoPlayer {
    width: 100%;
    height: calc(100% - 60px);
    background-color: black;
  }

  /* أزرار الجودة - بدون خلفية سوداء */
  #qualityButtons {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    overflow-x: auto;
    gap: 8px;
    padding: 6px 10px;
    box-sizing: border-box;
    z-index: 10003;
    transition: opacity 0.5s ease;
    opacity: 1;
  }

  #qualityButtons.hidden {
    opacity: 0;
    pointer-events: none;
  }

  #qualityButtons button {
    background-color: rgba(0,0,0,0.6);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    flex: 0 0 auto;
    transition: background-color 0.3s;
    white-space: nowrap;
  }

  #qualityButtons button:hover {
    background-color: rgba(255,255,255,0.2);
  }

  #qualityButtons button.active {
    background-color: #007bff;
  }

  /* زر المشغل الخارجي */
  #qualityButtons button.external-player {
    background-color: #28a745;
  }

  #qualityButtons button.external-player:hover {
    background-color: #218838;
  }

  /* زر الرجوع */
  #backButton {
    position: fixed;
    bottom: 15px;
    right: 15px;
    background-color: rgba(0,0,0,0.6);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 24px;
    cursor: pointer;
    z-index: 10004;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }

  /* التحميل */
  #loading {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 20px 30px;
    border-radius: 10px;
    z-index: 10003;
    display: none;
    text-align: center;
  }

  .loading-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @media (max-width: 768px) {
    .container, .channels-container {
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      padding: 8px;
    }
    .section-card, .channel-card { height: 180px; }
    .section-image, .channel-logo { width: 120px; height: 120px; }
    .section-title, .channel-name { font-size: 0.9rem; height: 28px; }
  }

  @media (max-width: 480px) {
    .container, .channels-container {
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px;
    }
    .section-card, .channel-card { height: 160px; }
    .section-image, .channel-logo { width: 100px; height: 100px; }
    .section-title, .channel-name { font-size: 0.85rem; height: 26px; padding: 6px 3px; }
  }
</style>
</head>
<body>

<!-- الواجهة الرئيسية -->
<div class="container" id="sectionsContainer"></div>
<div class="channels-container" id="channelsContainer" style="display:none;"></div>

<!-- المشغل - نفس التصميم الأصلي -->
<div id="playerContainer">
  <video id="videoPlayer" controls autoplay playsinline webkit-playsinline></video>
  <div id="qualityButtons" style="display:none;"></div>
</div>

<!-- زر الرجوع -->
<button id="backButton" title="الرجوع" style="display:none;">←</button>

<!-- التحميل -->
<div id="loading">
  <div class="loading-spinner"></div>
  <div>جاري التحميل...</div>
</div>

<!-- المكتبات -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
// التهيئة الأساسية
const firebaseConfig = {
  apiKey: "AIzaSyARzpeY20p5R1RXGYX_83zQkyLHywp-SE4",
  authDomain: "one-sport-67e48.firebaseapp.com",
  databaseURL: "https://one-sport-67e48-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "one-sport-67e48",
  storageBucket: "one-sport-67e48.appspot.com",
  messagingSenderId: "238395812570",
  appId: "1:238395812570:web:6361f8ecac34d1061fd3e3"
};

// تهيئة Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// العناصر
const sectionsContainer = document.getElementById("sectionsContainer");
const channelsContainer = document.getElementById("channelsContainer");
const playerContainer = document.getElementById("playerContainer");
const videoElement = document.getElementById("videoPlayer");
const backButton = document.getElementById("backButton");
const qualityButtons = document.getElementById("qualityButtons");
const loading = document.getElementById("loading");

let hls = null;
let currentCategoryId = null;

// ✅ إصلاح نظام التنقل - تخزين الحالة بشكل صحيح
let navigationStack = [];

const qualityKeys = [
  { key: 'urlMain', label: 'MAIN' },
  { key: 'urlHD', label: 'HD' },
  { key: 'urlSD', label: 'SD' },
  { key: 'urlLow', label: 'LOW' }
];

// تحميل الأقسام من Firebase
async function loadSections(parentId = '') {
  sectionsContainer.innerHTML = '';
  channelsContainer.style.display = 'none';
  playerContainer.style.display = 'none';
  
  // ✅ إصلاح: إخفاء زر الرجوع فقط في الصفحة الرئيسية
  if (parentId === '') {
    backButton.style.display = 'none';
    navigationStack = []; // مسح التاريخ عند الصفحة الرئيسية
  } else {
    backButton.style.display = 'flex';
  }

  try {
    const snapshot = await db.ref('categories').once("value");
    const categories = snapshot.val() || {};

    // ✅ إصلاح: تصفية الأقسام بشكل صحيح لمنع التكرار
    const filteredCategories = Object.entries(categories)
      .filter(([key, cat]) => (cat.parent || '') === parentId);

    if (filteredCategories.length > 0) {
      filteredCategories.forEach(([key, cat]) => {
        const card = document.createElement('div');
        card.className = 'section-card';
        card.innerHTML = `<img src="${cat.image || ''}" class="section-image"/><div class="section-title">${cat.name}</div>`;
        card.onclick = () => {
          // ✅ إصلاح: حفظ الحالة قبل الذهاب للقنوات
          navigationStack.push({
            type: 'sections',
            parentId: parentId,
            categoryId: key
          });
          loadChannels(key);
        };
        sectionsContainer.appendChild(card);
      });
      sectionsContainer.style.display = 'grid';
    } else {
      // ✅ إصلاح: حفظ الحالة قبل الذهاب للقنوات مباشرة
      navigationStack.push({
        type: 'sections',
        parentId: parentId,
        categoryId: parentId
      });
      loadChannels(parentId);
    }
  } catch (error) {
    sectionsContainer.innerHTML = '<div style="grid-column:1/-1;color:white;text-align:center;padding:20px;">خطأ في تحميل الأقسام</div>';
  }
}

// تحميل القنوات من Firebase
async function loadChannels(categoryId) {
  currentCategoryId = categoryId;
  sectionsContainer.style.display = 'none';
  channelsContainer.style.display = 'grid';
  playerContainer.style.display = 'none';
  backButton.style.display = 'flex';
  channelsContainer.innerHTML = '';

  try {
    const snapshot = await db.ref('channels')
      .orderByChild('category')
      .equalTo(categoryId)
      .once("value");
    
    const channels = snapshot.val() || {};

    if (Object.keys(channels).length === 0) {
      channelsContainer.innerHTML = '<div style="grid-column:1/-1;color:white;text-align:center;padding:20px;">لا توجد قنوات في هذا القسم</div>';
      return;
    }

    Object.entries(channels).forEach(([key, channel]) => {
      const card = document.createElement('div');
      card.className = 'channel-card';
      card.innerHTML = `<img src="${channel.logo || ''}" class="channel-logo"/><div class="channel-name">${channel.name}</div>`;
      card.onclick = () => {
        // ✅ إصلاح: حفظ الحالة قبل الذهاب للمشغل
        navigationStack.push({
          type: 'channels',
          categoryId: categoryId,
          parentId: getCurrentParentId()
        });
        
        // ✅ إذا كان هناك مشغل خارجي فقط، انتقل مباشرة إليه
        if (channel.embeddedPlayerCode && channel.embeddedPlayerCode.trim() !== '' && 
            getAllQualityLinks(channel).length === 0) {
          openExternalPlayer(channel.embeddedPlayerCode);
        } else {
          playChannel(channel);
        }
      };
      channelsContainer.appendChild(card);
    });
  } catch (error) {
    channelsContainer.innerHTML = '<div style="grid-column:1/-1;color:white;text-align:center;padding:20px;">خطأ في تحميل القنوات</div>';
  }
}

// ✅ دالة مساعدة للحصول على parentId الحالي
function getCurrentParentId() {
  if (navigationStack.length > 0) {
    const lastState = navigationStack[navigationStack.length - 1];
    return lastState.parentId || '';
  }
  return '';
}

// تشغيل القناة
function playChannel(channel) {
  sectionsContainer.style.display = 'none';
  channelsContainer.style.display = 'none';
  playerContainer.style.display = 'flex';
  backButton.style.display = 'flex';
  qualityButtons.innerHTML = '';

  if (hls) {
    hls.destroy();
    hls = null;
  }

  const qualityLinks = getAllQualityLinks(channel);
  
  // ✅ إضافة زر المشغل الخارجي إذا كان موجوداً
  if (channel.embeddedPlayerCode && channel.embeddedPlayerCode.trim() !== '') {
    qualityButtons.innerHTML = '';
    qualityButtons.style.display = 'flex';
    
    // إضافة أزرار الجودة العادية
    if (qualityLinks.length > 0) {
      qualityLinks.forEach(({label, url}, index) => {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.onclick = () => {
          loadStream(url, btn);
        };
        qualityButtons.appendChild(btn);
        if (index === 0) btn.classList.add('active');
      });
    }
    
    // إضافة زر المشغل الخارجي
    const externalBtn = document.createElement('button');
    externalBtn.textContent = 'مشغل خارجي';
    externalBtn.className = 'external-player';
    externalBtn.onclick = () => {
      openExternalPlayer(channel.embeddedPlayerCode);
    };
    qualityButtons.appendChild(externalBtn);
    
    // تشغيل الجودة الأولى تلقائياً
    if (qualityLinks.length > 0) {
      loadStream(qualityLinks[0].url, qualityButtons.children[0]);
    }
  } 
  else if (qualityLinks.length > 0) {
    // الكود القديم إذا لم يكن هناك مشغل خارجي
    qualityButtons.innerHTML = '';
    qualityButtons.style.display = 'flex';
    qualityLinks.forEach(({label, url}, index) => {
      const btn = document.createElement('button');
      btn.textContent = label;
      btn.onclick = () => {
        loadStream(url, btn);
      };
      qualityButtons.appendChild(btn);
      if (index === 0) btn.classList.add('active');
    });
    loadStream(qualityLinks[0].url, qualityButtons.children[0]);
  } else {
    alert('لا توجد روابط تشغيل متاحة لهذه القناة.');
  }
}

// ✅ الحل البسيط والفعال لـ AppCreator24
function openExternalPlayer(playerCode) {
  // ✅ الحل 1: فتح في iframe داخل التطبيق مع زر عودة
  const iframeHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <style>
        body { 
          margin: 0; padding: 50px 0 0 0; background: #000; 
          position: relative; min-height: 100vh;
        }
        .back-btn { 
          position: fixed; top: 10px; right: 10px; 
          background: #007bff; color: white; border: none; 
          padding: 10px 15px; border-radius: 20px; cursor: pointer; 
          z-index: 10000; font-size: 14px; font-weight: bold;
          box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
      </style>
    </head>
    <body>
      <button class="back-btn" onclick="window.parent.postMessage('closeExternalPlayer', '*')">
        ← العودة
      </button>
      ${playerCode}
    </body>
    </html>
  `;
  
  // ✅ إنشاء iframe لعرض المشغل الخارجي
  const iframe = document.createElement('iframe');
  iframe.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    border: none;
    z-index: 20000;
    background: #000;
  `;
  iframe.srcdoc = iframeHtml;
  document.body.appendChild(iframe);
  
  // ✅ الاستماع لرسالة الإغلاق من الـ iframe
  window.addEventListener('message', function(event) {
    if (event.data === 'closeExternalPlayer') {
      if (iframe && iframe.parentNode) {
        iframe.parentNode.removeChild(iframe);
      }
    }
  });
}

function getAllQualityLinks(channel) {
  const links = [];
  qualityKeys.forEach(({key, label}) => {
    if (channel[key]) links.push({label, url: channel[key]});
  });
  
  if (channel.extraLinks) {
    Object.entries(channel.extraLinks).forEach(([name, url]) => {
      if (name && url) links.push({label: name, url});
    });
  }
  
  return links;
}

function loadStream(url, activeBtn = null) {
  if (hls) {
    hls.destroy();
    hls = null;
  }
  if (activeBtn) {
    Array.from(qualityButtons.children).forEach(btn => {
      if (btn.classList.contains('external-player')) return;
      btn.classList.remove('active');
    });
    activeBtn.classList.add('active');
  }
  
  if (Hls.isSupported()) {
    hls = new Hls();
    hls.loadSource(url);
    hls.attachMedia(videoElement);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      videoElement.play();
    });
  } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
    videoElement.src = url;
    videoElement.addEventListener('loadedmetadata', () => {
      videoElement.play();
    });
  } else {
    alert('متصفحك لا يدعم تشغيل الفيديو.');
  }
}

// ✅ إصلاح زر الرجوع - نظام تنقل صحيح
backButton.onclick = () => {
  if (hls) {
    hls.destroy();
    hls = null;
  }
  videoElement.pause();
  videoElement.removeAttribute('src');
  videoElement.load();
  qualityButtons.style.display = 'none';

  if (navigationStack.length === 0) {
    loadSections();
    backButton.style.display = 'none';
    return;
  }

  const previousState = navigationStack.pop();
  
  switch (previousState.type) {
    case 'channels':
      loadChannels(previousState.categoryId);
      break;
      
    case 'sections':
      loadSections(previousState.parentId);
      break;
  }
};

// إعدادات الفيديو للتطبيقات
videoElement.setAttribute('playsinline', 'true');
videoElement.setAttribute('webkit-playsinline', 'true');
videoElement.setAttribute('x5-video-player-type', 'h5');
videoElement.setAttribute('x5-video-player-fullscreen', 'true');

// بدء التطبيق
loadSections();
</script>
</body>
</html>
