<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alfaham TV</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');
  body {
    margin: 0;
    font-family: 'Cairo', sans-serif;
    background: url('https://j.top4top.io/p_35842rci70.png') no-repeat center center fixed;
    background-size: cover;
    color: #fff;
    font-size: 0.85rem;
  }
  .container, .channels-container {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 15px;
    direction: rtl;
    justify-content: start;
    text-align: center;
  }
  .section-card, .channel-card {
    width: 100px; height: 140px;
    background: transparent; border: none;
    cursor: pointer; transition: transform 0.2s;
    display: flex; flex-direction: column;
    align-items: center; justify-content: flex-start;
  }
  .section-card:hover, .channel-card:hover { transform: scale(1.05); }
  .section-image, .channel-logo { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; border: 1px solid #444; margin-bottom:5px; }
  .section-title, .channel-name { font-weight: bold; font-size: 0.8rem; color: #fff; text-align:center; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
  #playerContainer { display: none; position: fixed; top:0; left:0; width:100vw; height:100vh; background:black; z-index:10000; flex-direction:column; }
  #videoPlayer { width:100%; height:calc(100% - 60px); background:black; }
  #qualityButtons { position:fixed; top:0; left:0; width:100%; background:rgba(0,0,0,0.7); display:flex; overflow-x:auto; gap:8px; padding:6px 10px; z-index:10003; }
  #qualityButtons button { background:rgba(0,0,0,0.6); color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold; white-space:nowrap; }
  #qualityButtons button.active { background:#007bff; }
  #qualityButtons button.external { background:#28a745; }
  #backButton { position:fixed; bottom:15px; right:15px; background:rgba(0,0,0,0.6); color:white; border:none; border-radius:50%; width:40px; height:40px; font-size:24px; cursor:pointer; z-index:10004; display:flex; align-items:center; justify-content:center; }
  .loading { text-align: center; padding: 20px; font-size: 1.2rem; }
</style>
</head>
<body>
<div class="container" id="sectionsContainer"></div>
<div class="channels-container" id="channelsContainer" style="display:none;"></div>

<div id="playerContainer">
  <video id="videoPlayer" 
         controls 
         autoplay 
         playsinline 
         webkit-playsinline 
         crossorigin="anonymous"></video>
  <div id="qualityButtons"></div>
</div>
<button id="backButton" style="display:none;">←</button>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyARzpeY20p5R1RXGYX_83zQkyLHywp-SE4",
  authDomain: "one-sport-67e48.firebaseapp.com",
  databaseURL: "https://one-sport-67e48-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "one-sport-67e48",
  storageBucket: "one-sport-67e48.appspot.com",
  messagingSenderId: "238395812570",
  appId: "1:238395812570:web:6361f8ecac34d1061fd3e3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const sectionsContainer = document.getElementById("sectionsContainer");
const channelsContainer = document.getElementById("channelsContainer");
const playerContainer = document.getElementById("playerContainer");
const videoElement = document.getElementById("videoPlayer");
const backButton = document.getElementById("backButton");
const qualityButtons = document.getElementById("qualityButtons");

let hls = null;
let currentCategoryId = null;

// كشف إذا كان التطبيق يعمل في AppMaster أو WebView
const isInApp = /WebView|AppMaster|Android|iPhone|iPad/i.test(navigator.userAgent);

async function loadSections(parentId = '') {
  sectionsContainer.innerHTML = '<div class="loading">جارٍ التحميل...</div>';
  channelsContainer.style.display = 'none';
  playerContainer.style.display = 'none';

  const snapshot = await db.ref('categories').once("value");
  const categories = snapshot.val() || {};
  sectionsContainer.innerHTML = '';

  const filteredCategories = Object.entries(categories).filter(([key, cat]) => (cat.parent||'')===parentId);

  if(filteredCategories.length>0){
    filteredCategories.forEach(([key, cat])=>{
      const card = document.createElement('div');
      card.className='section-card';
      card.innerHTML=`<img src="${cat.image||''}" class="section-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'"/><div class="section-title">${cat.name}</div>`;
      card.onclick=()=>loadChannels(key);
      sectionsContainer.appendChild(card);
    });
  }else{
    loadChannels(parentId);
  }
}

function loadChannels(categoryId){
  currentCategoryId=categoryId;
  sectionsContainer.style.display='none';
  channelsContainer.style.display='grid';
  playerContainer.style.display='none';
  backButton.style.display='flex';
  channelsContainer.innerHTML='<div class="loading">جارٍ تحميل القنوات...</div>';

  db.ref('channels').orderByChild('category').equalTo(categoryId).once("value").then(snapshot=>{
    const channels = snapshot.val() || {};
    channelsContainer.innerHTML='';
    if(Object.keys(channels).length===0){
      channelsContainer.innerHTML='<div class="loading">لا توجد قنوات في هذا القسم.</div>';
      return;
    }
    Object.entries(channels).forEach(([key,ch])=>{
      const card=document.createElement('div');
      card.className='channel-card';
      card.innerHTML=`<img src="${ch.logo||''}" class="channel-logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIExvZ288L3RleHQ+Cjwvc3ZnPgo='"/><div class="channel-name">${ch.name}</div>`;
      card.onclick=()=>playChannel(ch);
      channelsContainer.appendChild(card);
    });
  });
}

function playChannel(channel){
  // جمع كل الروابط
  const urls = [];
  if(channel.urlMain) urls.push({name:'Main', url:channel.urlMain});
  if(channel.urlHD) urls.push({name:'HD', url:channel.urlHD});
  if(channel.urlSD) urls.push({name:'SD', url:channel.urlSD});
  if(channel.urlLow) urls.push({name:'Low', url:channel.urlLow});
  if(channel.extraLinks){
    Object.entries(channel.extraLinks).forEach(([name,url])=>{
      if(name && url) urls.push({name,url});
    });
  }

  // المحاولة الأولى: استخدام مشغل AppMaster المدمج إذا كان متاحاً
  if (isInApp && typeof window.android !== 'undefined' && window.android.playVideo) {
    try {
      window.android.playVideo(urls[0].url, channel.name);
      return;
    } catch (e) {
      console.log('Android interface failed, falling back to web player');
    }
  }

  // المحاولة الثانية: استخدام المشغل العادي
  sectionsContainer.style.display='none';
  channelsContainer.style.display='none';
  playerContainer.style.display='flex';
  backButton.style.display='flex';
  qualityButtons.innerHTML='';

  // إعدادات محسنة للفيديو في WebView
  if(isInApp) {
    videoElement.setAttribute('playsinline', 'true');
    videoElement.setAttribute('webkit-playsinline', 'true');
    videoElement.setAttribute('crossorigin', 'anonymous');
  }

  urls.forEach((q,index)=>{
    const btn=document.createElement('button');
    btn.textContent=q.name;
    btn.onclick=()=>{
      if(hls) hls.destroy();
      
      if(q.url.endsWith('.m3u8') && Hls.isSupported()){
        hls=new Hls({
          enableWorker: false, // مهم للـ WebView
          lowLatencyMode: true,
          backBufferLength: 90,
          maxBufferLength: 30
        });
        hls.loadSource(q.url);
        hls.attachMedia(videoElement);
        hls.on(Hls.Events.MANIFEST_PARSED,()=>{
          videoElement.play().catch(e=>{
            console.log('Auto-play prevented:', e);
            // عرض رسالة للمستخدم للنقر على التشغيل
            videoElement.controls = true;
          });
        });
        hls.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                console.log('فشل في تحميل الفيديو، جاري المحاولة بالطريقة البديلة');
                videoElement.src = q.url;
                videoElement.play().catch(e => console.log('Play failed:', e));
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                hls.recoverMediaError();
                break;
              default:
                console.log('خطأ غير معروف في HLS');
                break;
            }
          }
        });
      }else{
        videoElement.src=q.url;
        videoElement.play().catch(e=>{
          console.log('Auto-play prevented:', e);
          videoElement.controls = true;
        });
      }
      Array.from(qualityButtons.children).forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    };
    if(index===0) btn.classList.add('active');
    qualityButtons.appendChild(btn);
  });

  // إضافة زر المشغل الخارجي كخيار بديل
  if (urls.length > 0) {
    const externalBtn = document.createElement('button');
    externalBtn.textContent = 'فتح في مشغل خارجي';
    externalBtn.className = 'external';
    externalBtn.onclick = () => {
      const firstUrl = urls[0].url;
      // محاولة فتح في مشغل خارجي
      window.open(firstUrl, '_blank');
    };
    qualityButtons.appendChild(externalBtn);
  }

  // تشغيل أول رابط تلقائيًا
  if(urls.length > 0){
    const first = urls[0];
    if(first.url.endsWith('.m3u8') && Hls.isSupported()){
      hls=new Hls({
        enableWorker: false,
        lowLatencyMode: true,
        backBufferLength: 90
      });
      hls.loadSource(first.url);
      hls.attachMedia(videoElement);
      hls.on(Hls.Events.MANIFEST_PARSED,()=>{
        videoElement.play().catch(e=>{
          console.log('Auto-play prevented:', e);
          videoElement.controls = true;
        });
      });
    }else{
      videoElement.src=first.url;
      videoElement.play().catch(e=>{
        console.log('Auto-play prevented:', e);
        videoElement.controls = true;
      });
    }
  }
}

backButton.onclick=()=>{
  if(hls) {
    hls.destroy();
    hls = null;
  }
  videoElement.pause();
  videoElement.removeAttribute('src');
  videoElement.load();
  
  if(playerContainer.style.display==='flex'){
    playerContainer.style.display='none';
    channelsContainer.style.display='grid';
    backButton.style.display='flex';
  }else if(channelsContainer.style.display==='grid'){
    channelsContainer.style.display='none';
    sectionsContainer.style.display='grid';
    backButton.style.display='none';
  }
};

// تحميل الأقسام عند بدء التشغيل
loadSections();

// إضافة event listener للتحكم في وضع الملء الشاشة
videoElement.addEventListener('webkitpresentationmodechanged', function(e) {
  console.log('Presentation mode changed: ', e.target.webkitPresentationMode);
});

// تحسين الأداء في الأجهزة المحمولة
if (isInApp) {
  document.addEventListener('DOMContentLoaded', function() {
    // تحسينات للأداء
    if ('connection' in navigator) {
      const connection = navigator.connection;
      if (connection.saveData) {
        console.log('وضع توفير البيانات مفعل');
      }
    }
  });
}
</script>
</body>
</html>
